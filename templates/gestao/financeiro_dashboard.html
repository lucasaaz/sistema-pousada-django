<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .main-container { display: flex; flex: 1; }
        .sidebar { width: 280px; background-color: #f8f9fa; border-right: 1px solid #dee2e6; }
        .content { flex: 1; padding: 2rem; }
        .sidebar .nav-link { color: #333; }
        .sidebar .nav-link.active, .sidebar .nav-link:hover { color: #007bff; background-color: #e9ecef; }
    </style>
</head>
<body>
<header class="navbar navbar-dark bg-dark sticky-top flex-md-nowrap p-0 shadow">
    <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3 fs-6" href="{% url 'dashboard' %}">Hotel Manager Pro</a>
    <div class="navbar-nav">
        <div class="nav-item text-nowrap">
            <a class="nav-link px-3" href="#">Sair</a>
        </div>
    </div>
</header>

<div class="container-fluid main-container">
    <!-- Sidebar -->
    <nav class="d-md-block sidebar">
        <div class="position-sticky pt-3">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" aria-current="page" href="{% url 'dashboard' %}">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'reserva_list' %}">
                        <i class="bi bi-calendar-check"></i> Reservas
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'cliente_list' %}">
                        <i class="bi bi-people"></i> Clientes
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'acomodacao_list' %}">
                        <i class="bi bi-building"></i> Acomodações
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'item_estoque_list' %}">
                        <i class="bi bi-box-seam"></i> Estoque
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'vaga_estacionamento_list' %}">
                        <i class="bi bi-p-square"></i> Estacionamento
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'relatorio_acomodacoes' %}">
                        <i class="bi bi-graph-up"></i> Relatórios
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="collapse" href="#configuracoesSubmenu" role="button" aria-expanded="false" aria-controls="configuracoesSubmenu">
                        <i class="bi bi-gear"></i> Configurações
                    </a>
                    <div class="collapse" id="configuracoesSubmenu">
                        <ul class="nav flex-column submenu">
                            <li class="nav-item"><a class="nav-link" href="{% url 'configuracao_hotel' %}">Dados do Hotel</a></li>
                            <li class="nav-item"><a class="nav-link" href="{% url 'forma_pagamento_list' %}">Formas de Pagamento</a></li>
                            <li class="nav-item"><a class="nav-link" href="{% url 'funcionario_list' %}">Funcionários</a></li>
                        </ul>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Conteúdo principal -->
    <main class="content">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Controle Financeiro</h1>

            <!-- Formulário de filtro por período -->
            <form method="get" class="mb-4 flex gap-2 items-end">
              <div>
                <label class="block text-sm text-gray-600">Início</label>
                <input type="date" name="start" value="{{ start|date:'Y-m-d' }}" class="form-control"/>
              </div>
              <div>
                <label class="block text-sm text-gray-600">Fim</label>
                <input type="date" name="end" value="{{ end|date:'Y-m-d' }}" class="form-control"/>
              </div>
              <button class="btn btn-primary h-10">Filtrar</button>
            </form>

            <!-- Mensagens -->
            {% if messages %}
              <div class="mb-4 space-y-2">
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                {% endfor %}
              </div>
            {% endif %}

            <!-- Resumo de reservas -->
            <div class="bg-white p-4 rounded-lg flex items-center justify-between mb-6">
              <div>
                <p class="text-sm text-gray-700 font-medium">Reservas no período</p>
                <p class="text-2xl font-bold text-gray-900 mt-1">{{ reservas_no_periodo }}</p>
              </div>
              <i class="bi bi-journal-check text-4xl text-gray-500"></i>
            </div>

            <!-- Resumo Financeiro do Mês -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Resumo do Mês</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Receita Total -->
                    <div class="bg-green-100 p-4 rounded-lg flex items-center justify-between">
                        <div>
                            <p class="text-sm text-green-700 font-medium">Receita Total</p>
                            <p class="text-2xl font-bold text-green-900 mt-1">R$ {{ total_entradas_caixa|floatformat:2 }}</p>
                        </div>
                        <i class="bi bi-currency-dollar text-4xl text-green-500"></i>
                    </div>
                    <!-- Despesas Totais -->
                    <div class="bg-red-100 p-4 rounded-lg flex items-center justify-between">
                        <div>
                            <p class="text-sm text-red-700 font-medium">Despesas Totais</p>
                            <p class="text-2xl font-bold text-red-900 mt-1">R$ {{ despesas_total_periodo|floatformat:2 }}</p>
                        </div>
                        <i class="bi bi-credit-card-2-front text-4xl text-red-500"></i>
                    </div>
                    <!-- Lucro/Prejuízo -->
                    <div class="{% if lucro_caixa_periodo >= 0 %}bg-blue-100{% else %}bg-orange-100{% endif %} p-4 rounded-lg flex items-center justify-between">
                        <div>
                            <p class="text-sm {% if lucro_caixa_periodo >= 0 %}text-blue-700{% else %}text-orange-700{% endif %} font-medium">Lucro/Prejuízo</p>
                            <p class="text-2xl font-bold {% if lucro_caixa_periodo >= 0 %}text-blue-900{% else %}text-orange-900{% endif %} mt-1">R$ {{ lucro_caixa_periodo|floatformat:2 }}</p>
                        </div>
                        <i class="bi bi-cash-stack text-4xl {% if lucro_caixa_periodo >= 0 %}text-blue-500{% else %}text-orange-500{% endif %}"></i>
                    </div>
                </div>
            </div>

            <!-- Gráficos Fluxo de Caixa e Receita por Categoria -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
              <div>
                <h3 class="text-md font-semibold text-gray-700 mb-2">Fluxo de Caixa (Mensal)</h3>
                <canvas id="linhaFluxo" height="220"></canvas>
              </div>
              <div>
                <h3 class="text-md font-semibold text-gray-700 mb-2">Receita por Categoria</h3>
                <canvas id="pizzaCategoria" height="220"></canvas>
                <ul class="list-unstyled small mt-3 mb-0">
                  <li>Quartos: <strong>R$ {{ receita_quartos|floatformat:2 }}</strong></li>
                  <li>Consumo: <strong>R$ {{ receita_consumo|floatformat:2 }}</strong></li>
                  <li>Outros: <strong>R$ {{ receita_outros|floatformat:2 }}</strong></li>
                  <li class="mt-1 text-muted">Total: R$ {{ total_receita_competencia|floatformat:2 }}</li>
                </ul>
              </div>
            </div>

            <!-- Inclusão de Gasto -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
              <h2 class="text-xl font-semibold text-gray-700 mb-4">Incluir gasto</h2>
              <form method="post" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                {% csrf_token %}
                <div>
                  <label class="block text-sm text-gray-600">{{ gasto_form.descricao.label }}</label>
                  {{ gasto_form.descricao }}
                </div>
                <div>
                  <label class="block text-sm text-gray-600">{{ gasto_form.valor.label }}</label>
                  {{ gasto_form.valor }}
                </div>
                <div>
                  <label class="block text-sm text-gray-600">{{ gasto_form.categoria.label }}</label>
                  {{ gasto_form.categoria }}
                </div>
                <div class="flex items-end">
                  <button class="btn btn-outline-primary w-full" type="submit">Salvar</button>
                </div>
              </form>
            </div>

            <!-- Dados JSON para gráficos -->
            {{ fluxo_caixa_mensal|json_script:"fluxo-data" }}
            {{ receita_por_categoria|json_script:"categoria-data" }}

        </div>
    </main>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Chart.js v4 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<script>
  const fluxoData = JSON.parse(document.getElementById('fluxo-data').textContent || '[]');
  const categoriaData = JSON.parse(document.getElementById('categoria-data').textContent || '[]');

  // Gráfico de linha: Receita vs Despesa
  const ctxLinha = document.getElementById('linhaFluxo')?.getContext('2d');
  if (ctxLinha && fluxoData.length) {
    const labels = fluxoData.map(p => p.label);
    const receitas = fluxoData.map(p => p.receita);
    const despesas = fluxoData.map(p => p.despesa);

    new Chart(ctxLinha, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Receita',
            data: receitas,
            borderColor: '#16a34a',
            backgroundColor: 'rgba(22,163,74,0.12)',
            tension: 0.25,
            fill: true
          },
          {
            label: 'Despesa',
            data: despesas,
            borderColor: '#dc2626',
            backgroundColor: 'rgba(220,38,38,0.12)',
            tension: 0.25,
            fill: true
          }
        ]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  }

  // Gráfico de pizza: Receita por categoria
  const ctxPizza = document.getElementById('pizzaCategoria')?.getContext('2d');
  if (ctxPizza && categoriaData.length) {
    new Chart(ctxPizza, {
      type: 'doughnut',
      data: {
        labels: categoriaData.map(c => c.label),
        datasets: [{
          data: categoriaData.map(c => c.valor),
          backgroundColor: ['#2563eb', '#22c55e', '#f59e0b'],
        }]
      }
    });
  }
</script>
</body>
</html>
