<!-- ==========================================================================-->
<!-- ARQUIVO: templates/gestao/financeiro_dashboard.html (REFATORADO)          -->
<!-- DESCRIÇÃO: Gestão financeira da pousada (com base.html).                  -->
<!-- ==========================================================================-->
{% extends 'base.html' %}

{% block title %}Painel Financeiro{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="h2 mb-4">Controle Financeiro</h1>

    <div class="row g-2">
        <div class="col-md-6">
            <!-- Formulário de filtro por período -->
            <form method="get" class="mb-4 d-flex gap-2 align-items-end flex-wrap">
                <div>
                    <label class="form-label small">Início</label>
                    <input type="date" name="start" value="{{ start|date:'Y-m-d' }}" class="form-control"/>
                </div>
                <div>
                    <label class="form-label small">Fim</label>
                    <input type="date" name="end" value="{{ end|date:'Y-m-d' }}" class="form-control"/>
                </div>
                <button class="btn btn-primary h-10">Filtrar</button>
            </form>
        </div>

        <div class="col-md-6">
            <!-- Resumo de reservas -->
            <div class="bg-white p-4 rounded-lg d-flex justify-content-between align-items-center mb-4 shadow-sm">
                <div>
                    <p class="text-muted small mb-1">Reservas finalizadas</p>
                    <p class="h3 mb-0">{{ reservas_no_periodo }}</p>
                </div>
                <i class="bi bi-journal-check fs-2 text-secondary"></i>
            </div>
        </div>
    </div>

    <!-- Resumo Financeiro do Mês -->
    <div class="bg-white p-4 rounded-lg shadow-sm mb-5">
        <h2 class="h5 mb-4">Resumo do Mês</h2>
        <div class="row g-3">
            <!-- Receita Total -->
            <div class="col-md-4">
                <div class="bg-success-subtle p-3 rounded d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-success small mb-1">Receita Total</p>
                        <p class="h4 mb-0">R$ {{ total_entradas_caixa|floatformat:2 }}</p>
                    </div>
                    <i class="bi bi-currency-dollar fs-2 text-success"></i>
                </div>
            </div>
            <!-- Despesas Totais -->
            <div class="col-md-4">
                <div class="bg-danger-subtle p-3 rounded d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-danger small mb-1">Despesas Totais</p>
                        <p class="h4 mb-0">R$ {{ despesas_total_periodo|floatformat:2 }}</p>
                    </div>
                    <i class="bi bi-credit-card-2-front fs-2 text-danger"></i>
                </div>
            </div>
            <!-- Lucro/Prejuízo -->
            <div class="col-md-4">
                <div class="{% if lucro_caixa_periodo >= 0 %}bg-primary-subtle{% else %}bg-warning-subtle{% endif %} p-3 rounded d-flex justify-content-between align-items-center">
                    <div>
                        <p class="small mb-1 {% if lucro_caixa_periodo >= 0 %}text-primary{% else %}text-warning{% endif %}">
                            Lucro/Prejuízo
                        </p>
                        <p class="h4 mb-0 {% if lucro_caixa_periodo >= 0 %}text-primary{% else %}text-warning{% endif %}">
                            R$ {{ lucro_caixa_periodo|floatformat:2 }}
                        </p>
                    </div>
                    <i class="bi bi-cash-stack fs-2 {% if lucro_caixa_periodo >= 0 %}text-primary{% else %}text-warning{% endif %}"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos Fluxo de Caixa e Receita por Categoria -->
    <div class="row g-4 mb-5">
        <div class="col-md-6">
            <h5 class="mb-2">Fluxo de Caixa (Mensal)</h5>
            <canvas id="linhaFluxo" height="220"></canvas>
        </div>
        <div class="col-md-6">
            <h5 class="mb-2">Receita por Categoria</h5>
            <canvas id="pizzaCategoria" height="220"></canvas>
            <ul class="list-unstyled small mt-3 mb-0">
                <li>Quartos: <strong>R$ {{ receita_quartos|floatformat:2 }}</strong></li>
                <li>Consumo: <strong>R$ {{ receita_consumo|floatformat:2 }}</strong></li>
                <li>Outros: <strong>R$ {{ receita_outros|floatformat:2 }}</strong></li>
                <li class="mt-1 text-muted">Total: R$ {{ total_receita_competencia|floatformat:2 }}</li>
            </ul>
        </div>
    </div>

    <!-- Inclusão de Gasto -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold text-primary">Adicionar Gasto</h6>
                    <a href="{% url 'categoria_gasto_list' %}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Gerenciar Categorias de Gasto">
                        <i class="bi bi-gear-fill"></i> Gerenciar Categorias
                    </a>
                </div>
                <div class="card-body">
                    {% if gasto_form.fields.categoria.queryset.exists %}
                        <form method="post" action="{% url 'financeiro' %}" class="row g-3">
                            {% csrf_token %}
                            <div class="col-md-12">
                                <label for="{{ gasto_form.descricao.id_for_label }}" class="form-label small">{{ gasto_form.descricao.label }}</label>
                                {{ gasto_form.descricao }}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ gasto_form.valor.id_for_label }}" class="form-label small">{{ gasto_form.valor.label }}</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    {{ gasto_form.valor }}
                                </div>
                                <div class="form-text small">{{ gasto_form.valor.help_text }}</div>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ gasto_form.categoria.id_for_label }}" class="form-label small">{{ gasto_form.categoria.label }}</label>
                                {{ gasto_form.categoria }}
                            </div>
                            <div class="col-12 d-grid pt-2">
                                <button class="btn btn-primary" type="submit">Lançar Gasto</button>
                            </div>
                        </form>
                    {% else %}
                        <div class="alert alert-warning text-center">
                            <p class="mb-2">Nenhuma categoria de gasto foi encontrada.</p>
                            <a href="{% url 'categoria_gasto_list' %}" class="btn btn-sm btn-primary">Adicione uma categoria</a>
                            <p class="small mt-2 mb-0">É preciso ter categorias para poder lançar um gasto.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light"><h6 class="m-0 fw-bold text-primary">Últimos Gastos Lançados</h6></div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for gasto in gastos_recentes %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-bold">{{ gasto.descricao }}</div>
                                <small class="text-muted">{{ gasto.get_categoria_display }} | {{ gasto.data_gasto|date:"d/m/Y" }}</small>
                            </div>
                            
                            <div class="d-flex align-items-center">
                                <span class="fw-bold text-danger me-3">- R$ {{ gasto.valor|floatformat:2 }}</span>
                                
                                <div class="btn-group">
                                    {% if perms.gestao.change_gasto %}
                                    <a href="{% url 'gasto_edit' gasto.pk %}" class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="Editar Gasto">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {% endif %}
                                    {% if perms.gestao.delete_gasto %}
                                    <a href="{% url 'gasto_delete' gasto.pk %}" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" title="Excluir Gasto">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </li>
                        {% empty %}
                        <li class="list-group-item text-center text-muted">Nenhum gasto lançado recentemente.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Dados JSON para gráficos -->
    {{ fluxo_caixa_mensal|json_script:"fluxo-data" }}
    {{ receita_por_categoria|json_script:"categoria-data" }}
</div>
{% endblock %}

{% block scripts %}

<style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .main-container { display: flex; flex: 1; }
    .sidebar { width: 280px; background-color: #f8f9fa; border-right: 1px solid #dee2e6; }
    .content { flex: 1; padding: 2rem; }
    .sidebar .nav-link { color: #333; }
    .sidebar .nav-link.active, .sidebar .nav-link:hover { color: #007bff; background-color: #e9ecef; }
</style>

<script>
  const fluxoData = JSON.parse(document.getElementById('fluxo-data').textContent || '[]');
  const categoriaData = JSON.parse(document.getElementById('categoria-data').textContent || '[]');

  // Gráfico de linha: Receita vs Despesa
  const ctxLinha = document.getElementById('linhaFluxo')?.getContext('2d');
  if (ctxLinha && fluxoData.length) {
    const labels = fluxoData.map(p => p.label);
    const receitas = fluxoData.map(p => p.receita);
    const despesas = fluxoData.map(p => p.despesa);

    new Chart(ctxLinha, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Receita',
            data: receitas,
            borderColor: '#16a34a',
            backgroundColor: 'rgba(22,163,74,0.12)',
            tension: 0.25,
            fill: true
          },
          {
            label: 'Despesa',
            data: despesas,
            borderColor: '#dc2626',
            backgroundColor: 'rgba(220,38,38,0.12)',
            tension: 0.25,
            fill: true
          }
        ]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  }

  // Gráfico de pizza: Receita por categoria
  const ctxPizza = document.getElementById('pizzaCategoria')?.getContext('2d');
  if (ctxPizza && categoriaData.length) {
    new Chart(ctxPizza, {
      type: 'doughnut',
      data: {
        labels: categoriaData.map(c => c.label),
        datasets: [{
          data: categoriaData.map(c => c.valor),
          backgroundColor: ['#2563eb', '#22c55e', '#f59e0b'],
        }]
      }
    });
  }
</script>
{% endblock %}
