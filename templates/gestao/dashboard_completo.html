<!-- ==========================================================================-->
<!-- ARQUIVO: templates/gestao/dashboard_completo.html (REFATORADO)            -->
<!-- DESCRIÇÃO: Dashboard (com base.html).                                     -->
<!-- ==========================================================================-->
{% extends 'base.html' %}

{% block title %}Painel de Controle Moderno{% endblock %}

{% block content %}
<div class="container-fluid">
    <main class="px-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
            <h1 class="h2">Painel da Pousada</h1>
        </div>

        <div class="row">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card shadow h-100 py-2 card-indicator card-indicator-primary">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div>
                                    <a class="nav-link text-xs fw-bold text-primary text-uppercase mb-1" href="{% url 'reserva_list' %}">
                                        Total de Reservas
                                    </a>
                                </div>
                                <div class="h5 mb-0 fw-bold text-gray-800">{{ total_reservas }}</div>
                            </div>
                            <div class="col-auto">
                                <a class="nav-link text-xs fw-bold text-primary text-uppercase mb-1" href="{% url 'reserva_list' %}">
                                    <i class="bi bi-calendar-check fs-2 text-gray-300"></i>
                                </a>
                            </div>  
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-6 mb-4">
                    <div class="card shadow h-100 py-2 card-indicator card-indicator-warning">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <a class="nav-link text-xs fw-bold text-warning text-uppercase mb-1" href="{% url 'reserva_list' %}?status=pre_reserva">
                                        Pré-Reservas
                                    </a>
                                    <div class="h5 mb-0 fw-bold text-gray-800">{{ pre_reservas }}</div>
                                </div>
                                <div class="col-auto">
                                    <a href="{% url 'reserva_list' %}?status=pre_reserva">
                                        <i class="bi bi-clock-history fs-2 text-gray-300"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <div class="col-xl-2 col-md-6 mb-4">
                <div class="card shadow h-100 py-2 card-indicator card-indicator-success">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div>
                                    <a class="nav-link text-xs fw-bold text-success text-uppercase mb-1" href="{% url 'reserva_list' %}?status=confirmada">
                                        Confirmadas
                                    </a>
                                </div>
                                <div class="h5 mb-0 fw-bold text-gray-800">{{ reservas_confirmadas }}</div>
                            </div>
                            <div class="col-auto">
                                <a class="nav-link text-xs fw-bold text-success text-uppercase mb-1" href="{% url 'reserva_list' %}?status=confirmada">
                                    <i class="bi bi-patch-check-fill fs-2 text-gray-300"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-md-6 mb-4">
                <div class="card shadow h-100 py-2 card-indicator card-indicator-info">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div>
                                    <a class="nav-link text-xs fw-bold text-info text-uppercase mb-1" href="{% url 'reserva_list' %}?status=checkin">
                                        Hóspedes Atuais
                                    </a>
                                </div>
                                <div class="h5 mb-0 fw-bold text-gray-800">{{ reservas_checkin }}</div>
                            </div>
                            <div class="col-auto">
                                <a class="nav-link text-xs fw-bold text-info text-uppercase mb-1" href="{% url 'reserva_list' %}?status=checkin">
                                    <i class="bi bi-door-open-fill fs-2 text-gray-300"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card shadow h-100 py-2 card-indicator border-danger">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div>
                                    <a class="nav-link text-xs fw-bold text-danger text-uppercase mb-1" href="{% url 'reserva_list' %}?status=checkout">
                                        Check-outs
                                    </a>
                                </div>
                                <div class="h5 mb-0 fw-bold text-gray-800">{{ reservas_checkout }}</div>
                            </div>
                            <div class="col-auto">
                                <a class="nav-link text-xs fw-bold text-danger text-uppercase mb-1" href="{% url 'reserva_list' %}?status=checkout">
                                    <i class="bi bi-box-arrow-right fs-2 text-gray-300"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 fw-bold text-primary">Status das Acomodações</h6>
            </div>
            <div class="card-body">
                <ul class="nav nav-pills mb-3" id="acomodacoesTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="todas-tab" data-bs-toggle="tab" data-bs-target="#todas-tab-pane" type="button">Todas</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="disponivel-tab" data-bs-toggle="tab" data-bs-target="#disponivel-tab-pane" type="button">Disponíveis <span class="badge bg-success-soft text-success">{{ acomodacoes_disponiveis|length }}</span></button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ocupada-tab" data-bs-toggle="tab" data-bs-target="#ocupada-tab-pane" type="button">Ocupadas <span class="badge bg-danger-soft text-danger">{{ acomodacoes_ocupadas|length }}</span></button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="limpeza-tab" data-bs-toggle="tab" data-bs-target="#limpeza-tab-pane" type="button">Limpeza <span class="badge bg-primary-soft text-primary">{{ acomodacoes_limpeza|length }}</span></button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="manutencao-tab" data-bs-toggle="tab" data-bs-target="#manutencao-tab-pane" type="button">Manutenção <span class="badge bg-secondary-soft text-secondary">{{ acomodacoes_manutencao|length }}</span></button>
                    </li>
                </ul>
                <div class="tab-content" id="acomodacoesTabContent">
                    <div class="tab-pane fade show active" id="todas-tab-pane">
                        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-3">
                            {% for acomodacao in acomodacoes %}
                            <div class="col">
                                <div class="card h-100 mudar-cor">
                                    <div class="card-body mudar-cor">
                                        <div class="d-flex justify-content-between">
                                            <h6 class="card-title fw-bold">
                                                <a href="{% url 'acomodacao_edit' acomodacao.pk %}" class="nav-link">{{ acomodacao.nome_display }} </a>
                                            </h6>
                                            {% if acomodacao.status == 'disponivel' %}<span class="badge bg-success-soft text-success">Disponível</span>
                                            {% elif acomodacao.status == 'ocupado' %}<span class="badge bg-danger-soft text-danger">Ocupado</span>
                                            {% elif acomodacao.status == 'limpeza' %}<span class="badge bg-primary-soft text-primary">Limpeza</span>
                                            {% else %}<span class="badge bg-secondary-soft text-secondary">Manutenção</span>
                                            {% endif %}
                                        </div>
                                        <p class="card-text text-muted small">{{ acomodacao.tipo.nome }}</p>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <p>Nenhuma acomodação encontrada.</p>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="tab-pane fade" id="disponivel-tab-pane">
                        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-3">
                            {% for acomodacao in acomodacoes_disponiveis %}
                            <div class="col">
                                <div class="card h-100 mudar-cor">
                                    <div class="card-body mudar-cor">
                                        <div class="d-flex justify-content-between">
                                            <h6 class="card-title fw-bold">
                                                <a href="{% url 'acomodacao_edit' acomodacao.pk %}" class="nav-link">{{ acomodacao.nome_display }} </a>
                                            </h6>
                                            <span class="badge bg-success-soft text-success">Disponível</span>
                                        </div>
                                        <p class="card-text text-muted small">{{ acomodacao.tipo.nome }}</p>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <p>Nenhuma acomodação com este status.</p>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="tab-pane fade" id="ocupada-tab-pane">
                        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-3">
                            {% for acomodacao in acomodacoes_ocupadas %}
                            <div class="col">
                                <div class="card h-100 mudar-cor">
                                    <div class="card-body mudar-cor">
                                        <div class="d-flex justify-content-between">
                                            <h6 class="card-title fw-bold">
                                                <a href="{% url 'acomodacao_edit' acomodacao.pk %}" class="nav-link">{{ acomodacao.nome_display }} </a>
                                            </h6>
                                            <span class="badge bg-danger-soft text-danger">Ocupado</span>
                                        </div>
                                        <p class="card-text text-muted small">{{ acomodacao.tipo.nome }}</p>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <p>Nenhuma acomodação com este status.</p>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="tab-pane fade" id="limpeza-tab-pane">
                        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-3">
                            {% for acomodacao in acomodacoes_limpeza %}
                            <div class="col">
                                <div class="card h-100 mudar-cor">
                                    <div class="card-body mudar-cor">
                                        <div class="d-flex justify-content-between">
                                            <h6 class="card-title fw-bold">
                                                <a href="{% url 'acomodacao_edit' acomodacao.pk %}" class="nav-link">{{ acomodacao.nome_display }} </a>
                                            </h6>
                                            <span class="badge bg-primary-soft text-primary">Limpeza</span>
                                        </div>
                                        <p class="card-text text-muted small">{{ acomodacao.tipo.nome }}</p>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <p>Nenhuma acomodação com este status.</p>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="tab-pane fade" id="manutencao-tab-pane">
                        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-3">
                            {% for acomodacao in acomodacoes_manutencao %}
                            <div class="col">
                                <div class="card h-100 mudar-cor">
                                    <div class="card-body mudar-cor">
                                        <div class="d-flex justify-content-between">
                                            <h6 class="card-title fw-bold">
                                                <a href="{% url 'acomodacao_edit' acomodacao.pk %}" class="nav-link">{{ acomodacao.nome_display }} </a>
                                            </h6>
                                            <span class="badge bg-secondary-soft text-secondary">Manutenção</span>
                                        </div>
                                        <p class="card-text text-muted small">{{ acomodacao.tipo.nome }}</p>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <p>Nenhuma acomodação com este status.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-5 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-primary">Análise de Reservas</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3 text-center">
                            <small class="text-muted">Taxa de Ocupação Atual</small>
                            <h2 class="fw-bolder">{{ taxa_ocupacao }}%</h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="reservasChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-7 mb-4">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-primary">Hóspedes na Pousada</h6>
                    </div>
                    <div class="card-body" style="max-height: 250px; overflow-y: auto;">
                        {% if reservas_ativas_list %}
                        <ul class="list-group list-group-flush">
                            {% for reserva in reservas_ativas_list %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold"><a href="{% url 'reserva_detail' reserva.pk %}" class="nav-link"> {{ reserva.cliente.nome_completo }} </a></div>
                                    <small class="text-muted">{{ reserva.acomodacao.nome_display }}</small>
                                </div>
                                <small>Até {{ reserva.data_checkout|date:"d/m" }}</small>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-muted text-center mt-3">Nenhum hóspede na pousada.</p>
                        {% endif %}
                    </div>
                </div>
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-primary">Reservas</h6>
                    </div>
                    <div class="card-body" style="max-height: 250px; overflow-y: auto;">
                        {% if proximas_reservas %}
                        <ul class="list-group list-group-flush">
                            {% for reserva in proximas_reservas %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold"><a href="{% url 'reserva_detail' reserva.pk %}" class="nav-link"> {{ reserva.cliente.nome_completo }} </a></div>
                                    <small class="text-muted">{{ reserva.acomodacao.nome_display }} - Sinal: R$ {{ reserva.total_pago|floatformat:2 }}</small>
                                </div>
                                <span class="badge bg-primary-soft text-primary">Em {{ reserva.data_checkin|date:"d/m/Y" }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-muted text-center mt-3">Nenhuma reserva futura agendada.</p>
                        {% endif %}
                    </div>
                </div>
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-primary">Pré-Reservas</h6>
                    </div>
                    <div class="card-body" style="max-height: 250px; overflow-y: auto;">
                        {% if proximas_prereservas %}
                        <ul class="list-group list-group-flush">
                            {% for reserva in proximas_prereservas %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold"><a href="{% url 'reserva_detail' reserva.pk %}" class="nav-link"> {{ reserva.cliente.nome_completo }} </a></div>
                                    <small class="text-muted">{{ reserva.acomodacao.nome_display }}</small>
                                </div>
                                <span class="badge bg-primary-soft text-primary">Em {{ reserva.data_checkin|date:"d/m/Y" }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-muted text-center mt-3">Nenhuma reserva futura agendada.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
    :root {
        --bs-primary-soft: #e7f1ff;
        --bs-success-soft: #e5f8f0;
        --bs-danger-soft: #fce8e9;
        --bs-info-soft: #e3f6f8;
        --bs-warning-soft: #fff8e1;
        --bs-secondary-soft: #f8f9fa;
        --bs-font-sans-serif: 'Poppins', sans-serif;
    }

    body {
        background-color: #f8f9fa;
        font-family: 'Inter', sans-serif;
    }

    .card {
        border: none;
        border-radius: 0.75rem;
        transition: all 0.3s ease;
    }

    .card.mudar-cor {
        background-color: #fcfcfc;
    }
    
    .card.card-indicator {
        border-left-width: 4px;
        border-left-style: solid;
    }
    .card-indicator-primary { border-color: var(--bs-primary); }
    .card-indicator-success { border-color: var(--bs-success); }
    .card-indicator-info { border-color: var(--bs-info); }
    .card-indicator-warning { border-color: var(--bs-warning); }


    .shadow {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1) !important;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 1rem 1.5rem rgba(0, 0, 0, 0.12) !important;
    }
    
    .text-gray-300 { color: #dddfeb !important; }

    .text-xs { font-size: 0.7rem; }
    
    .bg-primary-soft { background-color: var(--bs-primary-soft); }
    .bg-success-soft { background-color: var(--bs-success-soft); }
    .bg-danger-soft { background-color: var(--bs-danger-soft); }
    .bg-secondary-soft { background-color: var(--bs-secondary-soft); }


    .nav-pills .nav-link {
        color: #6c757d;
        font-weight: 500;
        border-radius: 0.5rem;
    }

    .nav-pills .nav-link.active, .nav-pills .show > .nav-link {
        color: #fff;
        background-color: var(--bs-primary);
    }
    
    .badge {
        font-weight: 600;
        padding: 0.4em 0.7em;
    }

    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusData = JSON.parse('{{ status_reservas|safe }}');
    const ctx = document.getElementById('reservasChart').getContext('2d');
    
    const labels = statusData.map(item => item.status);
    const data = statusData.map(item => item.count);
    
    // Cores modernas e consistentes com o tema
    const backgroundColors = [
        '#e0e0e0', // Cinza Claro (Cancelado)
        '#0dcaf0', // Azul claro (Check-in)
        '#dc3545', // Vermelho (Check-out)
        '#28a745', // Verde (Confirmada)
        '#ffae00', // Laranja (Pre-reserva)
    ];

    new Chart(ctx, {
        type: 'doughnut', // Gráfico de rosca, mais moderno
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors,
                hoverOffset: 8,
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        boxWidth: 12,
                        font: {
                            family: 'Poppins'
                        }
                    }
                }
            },
            cutout: '75%' // Controla o tamanho do "buraco" no centro
        }
    });
});
</script>
{% endblock %}