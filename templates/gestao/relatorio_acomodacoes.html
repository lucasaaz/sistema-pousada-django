<!-- ========================================================================== -->
<!-- ARQUIVO: templates/gestao/relatorio_acomodacoes.html (ATUALIZADO)          -->
<!-- ========================================================================== -->
{% extends 'base.html' %}
{% block title %}Relatórios e Análises{% endblock %}

{% block content %}
<main class="px-md-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Relatórios e Análises</h1>
    </div>

    <div class="row">
        <div class="col-lg-5 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <h6 class="m-0 fw-bold text-primary"><i class="bi bi-bar-chart-line-fill me-2"></i>Acomodações Mais Reservadas</h6>
                </div>
                <div class="card-body d-flex align-items-center">
                    {% if ranking_data_json and ranking_data_json != '{"labels": [], "data": []}' %}
                    <div class="chart-container">
                        <canvas id="rankingChart"></canvas>
                    </div>
                    {% else %}
                    <p class="text-center text-muted w-100">Não há dados de reservas para gerar o ranking.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-7 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="m-0 fw-bold text-primary"><i class="bi bi-file-earmark-text-fill me-2"></i>Extrato de Pagamentos</h6>
                </div>
                <div class="card-body">
                    <form method="get" action="{% url 'relatorio_acomodacoes' %}" class="row g-3 mb-4">
                        <div class="col-md-12">
                            <input type="search" class="form-control" name="q" placeholder="Buscar por Hóspede, CPF ou Quarto" value="{{ request.GET.q|default:'' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="start_date" class="form-label small">De:</label>
                            <input type="date" class="form-control" name="start_date" id="start_date" value="{{ request.GET.start_date|default:'' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="end_date" class="form-label small">Até:</label>
                            <input type="date" class="form-control" name="end_date" id="end_date" value="{{ request.GET.end_date|default:'' }}">
                        </div>
                        <div class="col-12 d-flex justify-content-end">
                            <a href="{% url 'relatorio_acomodacoes' %}" class="btn btn-outline-secondary me-2">Limpar</a>
                            <button class="btn btn-primary" type="submit">Filtrar Extrato</button>
                        </div>
                    </form>
                    
                    <div class="accordion" id="extratoAccordion">
                        {% for item in page_obj %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading-{{ item.reserva.pk }}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ item.reserva.pk }}">
                                    <div class="w-100 d-flex justify-content-between pe-3">
                                        <span><i class="bi bi-person-fill me-2"></i><strong>{{ item.reserva.cliente.nome_completo }}</strong> 
                                            Quarto: <span class="fw-bold">{{ item.reserva.acomodacao.numero }}</span> 
                                            Data:<strong>{{ item.reserva.data_checkin|date:"d/m"}} à {{ item.reserva.data_checkout|date:"d/m"}}</strong> </span>
                                        <span class="fw-bold text-success">Total Pago: R$ {{ item.total_pago|floatformat:2 }}</span>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse-{{ item.reserva.pk }}" class="accordion-collapse collapse" data-bs-parent="#extratoAccordion">
                                <div class="accordion-body">
                                    <p><strong>Acomodação:</strong> Quarto {{ item.reserva.acomodacao.numero }}</p>
                                    <p class="small text-muted"><strong>Período:</strong> {{ item.reserva.data_checkin|date:"d/m/Y" }} a {{ item.reserva.data_checkout|date:"d/m/Y" }}</p>
                                    
                                    <h6><i class="bi bi-cash-stack me-1"></i>Pagamentos</h6>
                                    <table class="table table-sm table-bordered">
                                        <tbody>
                                            {% for pagamento in item.pagamentos %}
                                            <tr>
                                                <td>{{ pagamento.data_pagamento|date:"d/m" }}</td><td>R$ {{ pagamento.valor|floatformat:2 }}</td><td>{{ pagamento.forma_pagamento}}</td>
                                            </tr>
                                            {% empty %}
                                            <tr><td colspan="3" class="text-center small">Nenhum pagamento</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>

                                    <h6><i class="bi bi-people me-1"></i>Hóspedes</h6>
                                    <table class="table table-sm table-bordered">
                                        <tbody>
                                            <tr>
                                                <td>Adulto(s)</td>
                                                <td class="text-end fw-bold">{{ item.reserva.num_adultos }}</td>
                                            </tr>

                                            {% if item.reserva.num_criancas_5 > 0 %}
                                            <tr>
                                                <td>Criança(s) até 5 anos</td>
                                                <td class="text-end fw-bold">{{ item.reserva.num_criancas_5 }}</td>
                                            </tr>
                                            {% endif %}

                                            {% if item.reserva.num_criancas_12 > 0 %}
                                            <tr>
                                                <td>Criança(s) de 6 a 12 anos</td>
                                                <td class="text-end fw-bold">{{ item.reserva.num_criancas_12 }}</td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                    
                                    <h6><i class="bi bi-car-front me-1"></i>Automóvel</h6>
                                    <table class="table table-sm table-bordered">
                                        <tbody>
                                            {% if item.reserva.placa_automovel %}
                                            <tr> 
                                                <td>Placa</td></td> 
                                                <td>class="fw-bold"> {{ item.reserva.placa_automovel }} </td>
                                            </tr>
                                            {% else %}   
                                            <tr><td colspan="2" class="text-center small">Nenhum automóvel</td></tr>
                                            {% endif %}
                                        </tbody>
                                    </table>

                                    <h6><i class="bi bi-door-closed me-1"></i>Hospedagem</h6>
                                    <table class="table table-sm table-bordered">
                                        <tbody>
                                            <tr><td>{{ item.reserva.acomodacao.nome_display }} - {{ item.reserva.num_dias }} dia(s)</td><td>R$ {{ item.reserva.valor_total_diarias|floatformat:2 }}</td></tr>
                                        </tbody>
                                    </table>

                                    <h6><i class="bi bi-cup-straw me-1"></i>Consumos</h6>
                                    <table class="table table-sm table-bordered">
                                        <tbody>
                                            {% for consumo in item.consumos %}
                                            <tr><td>{{ consumo.item.nome }} ({{ consumo.quantidade }}x)</td><td>R$ {{ consumo.total|floatformat:2 }}</td></tr>
                                            {% empty %}
                                            <tr><td colspan="2" class="text-center small">Nenhum consumo</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <hr>
                                    <div class="text-end fw-bold">
                                        <span>Total Geral: R$ {{ item.reserva.total_a_pagar|floatformat:2 }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-center text-muted mt-4">Nenhum extrato encontrado para os filtros aplicados.</p>
                        {% endfor %}
                    </div>
                </div>

                {% if page_obj.paginator.num_pages > 1 %}
                <div class="card-footer">
                    <nav aria-label="Navegação do extrato">
                        <ul class="pagination justify-content-center mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item"><a class="page-link" href="?page=1&{{ request.GET.urlencode }}">&laquo; Primeira</a></li>
                                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}">Anterior</a></li>
                            {% endif %}
                            <li class="page-item disabled"><span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span></li>
                            {% if page_obj.has_next %}
                                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}">Próxima</a></li>
                                <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&{{ request.GET.urlencode }}">Última &raquo;</a></li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
{{ block.super }}

<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .chart-container { position: relative; height: 100%; width: 100%; min-height: 350px; }
</style>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const rankingData = JSON.parse('{{ ranking_data_json|safe }}');

    if (rankingData && rankingData.labels.length > 0) {
        // --- MELHORIA 1: CORES DINÂMICAS ---
        const colors = [
            'rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)',
            'rgba(75, 192, 192, 0.7)', 'rgba(255, 206, 86, 0.7)',
            'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
            'rgba(99, 255, 132, 0.7)', 'rgba(201, 203, 207, 0.7)',
            'rgba(54, 162, 100, 0.7)', 'rgba(255, 99, 50, 0.7)'
        ];

        // Registra o plugin de rótulos de dados
        Chart.register(ChartDataLabels);

        const ctx = document.getElementById('rankingChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: rankingData.labels,
                datasets: [{
                    label: 'Total de Reservas',
                    data: rankingData.data,
                    backgroundColor: colors, // Usa o array de cores
                    borderColor: colors.map(color => color.replace('0.7', '1')), // Bordas mais sólidas
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y', // Mantém o gráfico de barras horizontal
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false // Legenda continua oculta
                    },
                    // --- MELHORIA 2: RÓTULOS DE DADOS NAS BARRAS ---
                    datalabels: {
                        color: '#fff',
                        anchor: 'end',
                        align: 'start',
                        offset: -30, // Posição dentro da barra
                        font: {
                            weight: 'bold'
                        },
                        formatter: (value) => {
                            return value > 0 ? value : ''; // Só mostra se o valor for maior que 0
                        }
                    },
                    // --- MELHORIA 3: TOOLTIPS MELHORADOS ---
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.x !== null) {
                                    label += context.parsed.x;
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        },
                        title: {
                            display: true,
                            text: 'Quantidade de Reservas'
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}