<!-- ========================================================================== -->
<!-- ARQUIVO: templates/gestao/cliente_form.html (NOVO FICHEIRO)              -->
<!-- DESCRI√á√ÉO: P√°gina com o formul√°rio para adicionar ou editar um cliente.  -->
<!-- ========================================================================== -->
{% extends "base.html" %}
{% block title %}{% if object %}Editar Cliente{% else %}Adicionar Cliente{% endif %}{% endblock %}

{% block content %}
<main class="px-md-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">{% if object %}Editar Cliente{% else %}Adicionar Novo Cliente{% endif %}</h1>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <form method="post" novalidate enctype="multipart/form-data">
                {% csrf_token %}
                <h5 class="mb-3">Dados Pessoais</h5>
                <div class="row g-3">
                    <div class="col-md-12">
                        <label class="form-label">{{ form.nome_completo.label }}</label>
                        {{ form.nome_completo }}
                    </div>
                    <div class="col-md-6"><label class="form-label">{{ form.cpf.label }}</label>{{ form.cpf }} <div id="cpf-feedback" class="invalid-feedback d-block"></div> </div>
                    <div class="col-md-6"><label class="form-label">{{ form.data_nascimento.label }}</label>{{ form.data_nascimento }}</div>
                    <div class="col-md-6"><label class="form-label">{{ form.email.label }}</label>{{ form.email }} <div id="email-feedback" class="invalid-feedback d-block"></div> </div>
                    <div class="col-md-6"><label class="form-label">{{ form.telefone.label }}</label>{{ form.telefone }}</div>
                </div>

                <hr class="my-4">
                <h5 class="mb-3">Endere√ßo</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">{{ form.cep.label }}</label>
                        {{ form.cep }}
                        <div id="cep-feedback" class="small text-muted"></div>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">{{ form.logradouro.label }}</label>
                        {{ form.logradouro }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">{{ form.numero.label }}</label>
                        {{ form.numero }}
                    </div>
                     <div class="col-md-8">
                        <label class="form-label">{{ form.complemento.label }}</label>
                        {{ form.complemento }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">{{ form.bairro.label }}</label>
                        {{ form.bairro }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">{{ form.cidade.label }}</label>
                        {{ form.cidade }}
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">{{ form.estado.label }}</label>
                        {{ form.estado }}
                    </div>
                </div>

                <hr class="my-4">
                <h5 class="mb-3">Foto do Cliente</h5>

                {% if cliente.foto %}
                    <div class="mb-3">
                        <p class="mb-1 small text-muted">Foto atual:</p>
                        <img src="{{ cliente.foto.url }}" alt="Foto de {{ cliente.nome_completo }}" class="img-thumbnail" style="max-width: 250px;">
                    </div>
                {% endif %}

                {{ form.foto }}
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#cameraModal">
                    <i class="bi bi-camera-fill me-1"></i> 
                    {% if cliente.foto %}Alterar Foto{% else %}Abrir C√¢mera{% endif %}
                </button>
                <div class="mt-3">
                    <img id="foto-preview" src="#" alt="Foto capturada" class="img-thumbnail" style="max-width: 250px; display: none;">
                </div>                

                <div class="card-footer bg-white text-end px-0 pt-4 mt-2">
                    <a href="{% url 'cliente_list' %}" class="btn btn-secondary">Cancelar</a>
                    
                    <button type="submit" name="action" value="save" class="btn btn-primary">
                        Salvar
                    </button>
                    
                    <button type="submit" name="action" value="save_and_reserve" class="btn btn-success">
                        Salvar e Ir para Reserva
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<div class="modal fade" id="cameraModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Capturar Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <video id="video" width="640" height="480" autoplay class="img-fluid"></video>
                <canvas id="canvas" style="display:none;"></canvas>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" id="snap" class="btn btn-primary">Capturar Foto</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

// Script para buscar endere√ßo via API do ViaCEP
{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // CEP - Campos do formul√°rio preenchidos automaticamente
    const cepInput = document.getElementById('cep-input');
    const logradouroInput = document.getElementById('logradouro-input');
    const bairroInput = document.getElementById('bairro-input');
    const cidadeInput = document.getElementById('cidade-input');
    const estadoInput = document.getElementById('estado-input');
    const feedbackDiv = document.getElementById('cep-feedback');

    cepInput.addEventListener('blur', function() {
        // 'blur' √© acionado quando o utilizador clica fora do campo do CEP
        const cep = cepInput.value.replace(/\D/g, ''); // Remove caracteres n√£o num√©ricos

        if (cep.length !== 8) {
            feedbackDiv.textContent = '';
            return;
        }

        feedbackDiv.textContent = 'A procurar...';

        fetch(`https://viacep.com.br/ws/${cep}/json/`)
            .then(response => response.json())
            .then(data => {
                if (data.erro) {
                    feedbackDiv.textContent = 'CEP n√£o encontrado.';
                    logradouroInput.value = '';
                    bairroInput.value = '';
                    cidadeInput.value = '';
                    estadoInput.value = '';
                } else {
                    feedbackDiv.textContent = 'CEP encontrado!';
                    logradouroInput.value = data.logradouro;
                    bairroInput.value = data.bairro;
                    cidadeInput.value = data.localidade;
                    estadoInput.value = data.uf;
                }
            })
            .catch(error => {
                feedbackDiv.textContent = 'Erro ao buscar CEP.';
                console.error('Erro:', error);
            });
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const snapButton = document.getElementById('snap');
    const fotoPreview = document.getElementById('foto-preview');
    const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));

    // Campo do formul√°rio Django
    const fotoInput = document.getElementById('{{ form.foto.id_for_label }}');

    // Inicia a c√¢mera quando o modal abre
    document.getElementById('cameraModal').addEventListener('shown.bs.modal', async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            video.srcObject = stream;
            console.log("üì∑ C√¢mera iniciada com sucesso");
        } catch (err) {
            console.error("‚ùå Erro ao acessar a c√¢mera: ", err);
            alert("N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes do navegador.");
            cameraModal.hide();
        }
    });

    // Para a c√¢mera quando o modal fecha
    document.getElementById('cameraModal').addEventListener('hidden.bs.modal', () => {
        const stream = video.srcObject;
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            console.log("üõë C√¢mera parada (modal fechado)");
        }
    });

    // Bot√£o para capturar a foto
    snapButton.addEventListener('click', function () {
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        console.log("üì∏ Foto capturada no canvas");

        // Converte para blob (arquivo)
        canvas.toBlob(function(blob) {
            if (!blob) {
                console.error("‚ùå Erro: blob n√£o foi gerado");
                return;
            }
            console.log("‚úÖ Blob gerado:", blob);

            const file = new File([blob], "foto_cliente.jpg", { type: "image/jpeg" });
            console.log("‚úÖ File criado:", file);

            // Preenche input do Django
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fotoInput.files = dataTransfer.files;
            console.log("‚úÖ File anexado ao input:", fotoInput.files);

            // Preview com URL do arquivo
            const objectUrl = URL.createObjectURL(file);
            fotoPreview.src = objectUrl;
            fotoPreview.style.display = 'block';
            console.log("üëÄ Preview gerado:", objectUrl);

            // For√ßa evento de mudan√ßa
            fotoInput.dispatchEvent(new Event('change', { bubbles: true }));
            console.log("üîî Evento change disparado");

            // S√≥ fecha o modal depois que o preview foi carregado
            fotoPreview.onload = () => {
                console.log("üü¢ Preview carregado com sucesso");
                URL.revokeObjectURL(objectUrl); // libera mem√≥ria
                cameraModal.hide();
            };

        }, 'image/jpeg');
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Pega os elementos dos campos pelo atributo 'name' - Mascara para CPF, CEP e Telefone
    const cpfInput = document.querySelector('input[name="cpf"]');
    const CepInput = document.querySelector('input[name="cep"]');
    const telefoneInput = document.querySelector('input[name="telefone"]');

    // Op√ß√µes da m√°scara para o telefone (aceita 8 ou 9 d√≠gitos)
    const telefoneMaskOptions = {
        mask: [
            { mask: '(00) 0000-0000' },
            { mask: '(00) 00000-0000' }
        ]
    };

    // Aplica as m√°scaras
    if(cpfInput)      IMask(cpfInput,      { mask: '000.000.000-00' });
    if(CepInput)      IMask(CepInput,      { mask: '00000-000' });
    if(telefoneInput) IMask(telefoneInput, { mask: '(00) 00000-0000' });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const cpfInput = document.querySelector('input[name="cpf"]');
    const emailInput = document.querySelector('input[name="email"]');
    
    // Pega o ID do cliente da URL, se estiver na p√°gina de edi√ß√£o
    const urlParts = window.location.pathname.split('/');
    const clienteId = urlParts.includes('editar') ? urlParts[urlParts.length - 2] : '';

    // Fun√ß√£o gen√©rica para verificar um campo
    const checkField = (inputElement, fieldName, feedbackElementId) => {
        const feedbackDiv = document.getElementById(feedbackElementId);
        
        inputElement.addEventListener('blur', function() { // 'blur' √© quando o usu√°rio sai do campo
            const value = inputElement.value;
            if (value.length === 0) {
                feedbackDiv.textContent = '';
                return;
            }

            // Monta a URL da nossa API
            const url = `{% url 'api_verificar_duplicidade' %}?field=${fieldName}&value=${value}&cliente_id=${clienteId}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.is_taken) {
                        feedbackDiv.textContent = `Este ${fieldName} j√° est√° cadastrado.`;
                        inputElement.classList.add('is-invalid');
                    } else {
                        feedbackDiv.textContent = '';
                        inputElement.classList.remove('is-invalid');
                    }
                });
        });
    };

    // Aplica a fun√ß√£o para os campos de CPF e Email
    if (cpfInput) checkField(cpfInput, 'cpf', 'cpf-feedback');
    if (emailInput) checkField(emailInput, 'email', 'email-feedback');
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const nascimentoInput = document.getElementById('{{ form.data_nascimento.id_for_label }}');
    const nascimentoValue = '{{ nascimento_para_js|default:"" }}';

    if (nascimentoInput && nascimentoValue) {
        nascimentoInput.value = nascimentoValue;
    }
});
</script>
{% endblock %}



