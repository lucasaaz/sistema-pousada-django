<!-- ========================================================================== -->
<!-- ARQUIVO: templates/gestao/cliente_form.html (NOVO FICHEIRO)              -->
<!-- DESCRIÇÃO: Página com o formulário para adicionar ou editar um cliente.  -->
<!-- ========================================================================== -->
{% extends "base.html" %}
{% block title %}{% if object %}Editar Cliente{% else %}Adicionar Cliente{% endif %}{% endblock %}

{% block content %}
<main class="px-md-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">{% if object %}Editar Cliente{% else %}Adicionar Novo Cliente{% endif %}</h1>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <form method="post" novalidate>
                {% csrf_token %}
                <h5 class="mb-3">Dados Pessoais</h5>
                <div class="row g-3">
                    <div class="col-md-12">
                        <label class="form-label">{{ form.nome_completo.label }}</label>
                        {{ form.nome_completo }}
                    </div>
                    <div class="col-md-6"><label class="form-label">{{ form.cpf.label }}</label>{{ form.cpf }} <div id="cpf-feedback" class="invalid-feedback d-block"></div> </div>
                    <div class="col-md-6"><label class="form-label">{{ form.data_nascimento.label }}</label>{{ form.data_nascimento }}</div>
                    <div class="col-md-6"><label class="form-label">{{ form.email.label }}</label>{{ form.email }} <div id="email-feedback" class="invalid-feedback d-block"></div> </div>
                    <div class="col-md-6"><label class="form-label">{{ form.telefone.label }}</label>{{ form.telefone }}</div>
                </div>

                <hr class="my-4">
                <h5 class="mb-3">Endereço</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">{{ form.cep.label }}</label>
                        {{ form.cep }}
                        <div id="cep-feedback" class="small text-muted"></div>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">{{ form.logradouro.label }}</label>
                        {{ form.logradouro }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">{{ form.numero.label }}</label>
                        {{ form.numero }}
                    </div>
                     <div class="col-md-8">
                        <label class="form-label">{{ form.complemento.label }}</label>
                        {{ form.complemento }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">{{ form.bairro.label }}</label>
                        {{ form.bairro }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">{{ form.cidade.label }}</label>
                        {{ form.cidade }}
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">{{ form.estado.label }}</label>
                        {{ form.estado }}
                    </div>
                </div>

                <hr class="my-4">
                <h5 class="mb-3">Foto do Cliente</h5>

                {% if cliente and cliente.foto %}
                    <div class="mb-3">
                        <p class="mb-1 small text-muted">Foto atual:</p>
                        <img src="{{ cliente.foto }}" alt="Foto de {{ cliente.nome_completo }}" class="img-thumbnail" style="max-width: 250px;">
                    </div>
                {% endif %}

                {{ form.foto }}
                <!-- Fallback: se o browser não anexar o arquivo ao input, enviaremos a dataURL aqui -->
                <input type="hidden" id="foto-dataurl" name="foto_dataurl" value="">
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#cameraModal">
                    <i class="bi bi-camera-fill me-1"></i> 
                    {% if cliente.foto %}Alterar Foto{% else %}Abrir Câmera{% endif %}
                </button>
                <div class="mt-3">
                    <img id="foto-preview" src="#" alt="Foto capturada" class="img-thumbnail" style="max-width: 250px; display: none;">
                </div>                

                <div class="card-footer bg-white text-end px-0 pt-4 mt-2">
                    <a href="{% url 'cliente_list' %}" class="btn btn-secondary">Cancelar</a>
                    
                    <button type="submit" name="action" value="save" class="btn btn-primary">
                        Salvar
                    </button>
                    
                    <button type="submit" name="action" value="save_and_reserve" class="btn btn-success">
                        Salvar e Ir para Reserva
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<div class="modal fade" id="cameraModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Capturar Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <video id="video" width="640" height="480" autoplay class="img-fluid"></video>
                <canvas id="canvas" style="display:none;"></canvas>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" id="snap" class="btn btn-primary">Capturar Foto</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

// Script para buscar endereço via API do ViaCEP
{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // CEP - Campos do formulário preenchidos automaticamente
    const cepInput = document.getElementById('cep-input');
    const logradouroInput = document.getElementById('logradouro-input');
    const bairroInput = document.getElementById('bairro-input');
    const cidadeInput = document.getElementById('cidade-input');
    const estadoInput = document.getElementById('estado-input');
    const feedbackDiv = document.getElementById('cep-feedback');

    cepInput.addEventListener('blur', function() {
        // 'blur' é acionado quando o utilizador clica fora do campo do CEP
        const cep = cepInput.value.replace(/\D/g, ''); // Remove caracteres não numéricos

        if (cep.length !== 8) {
            feedbackDiv.textContent = '';
            return;
        }

        feedbackDiv.textContent = 'A procurar...';

        fetch(`https://viacep.com.br/ws/${cep}/json/`)
            .then(response => response.json())
            .then(data => {
                if (data.erro) {
                    feedbackDiv.textContent = 'CEP não encontrado.';
                    logradouroInput.value = '';
                    bairroInput.value = '';
                    cidadeInput.value = '';
                    estadoInput.value = '';
                } else {
                    feedbackDiv.textContent = 'CEP encontrado!';
                    logradouroInput.value = data.logradouro;
                    bairroInput.value = data.bairro;
                    cidadeInput.value = data.localidade;
                    estadoInput.value = data.uf;
                }
            })
            .catch(error => {
                feedbackDiv.textContent = 'Erro ao buscar CEP.';
                console.error('Erro:', error);
            });
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const canvas = document.getElementById('canvas');
    const snapButton = document.getElementById('snap');
    const fotoPreview = document.getElementById('foto-preview');
    const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
    const fotoUrlInput = document.getElementById('foto_dataurl');
    
    // IMPORTANTE: Definimos a variável 'video' aqui, mas pegamos o elemento DEPOIS
    let video; 

    // Quando o modal for aberto, inicia a câmera
    document.getElementById('cameraModal').addEventListener('shown.bs.modal', async () => {
        // --- CORREÇÃO APLICADA AQUI ---
        // Pegamos o elemento de vídeo SÓ DEPOIS que temos certeza que o modal está visível
        video = document.getElementById('video');
        
        try {
            if (!video) {
                throw new Error("Elemento de vídeo não encontrado no modal.");
            }
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            video.srcObject = stream;
        } catch (err) {
            console.error("Erro ao acessar a câmera: ", err);
            alert("Não foi possível acessar a câmera. Verifique as permissões do seu navegador.");
            cameraModal.hide();
        }
    });

    // Quando o modal for fechado, para a câmera
    document.getElementById('cameraModal').addEventListener('hidden.bs.modal', () => {
        if (video && video.srcObject) {
            const stream = video.srcObject;
            const tracks = stream.getTracks();
            tracks.forEach(track => track.stop());
            video.srcObject = null;
        }
    });

    // O resto do script para capturar e fazer o upload continua o mesmo
    snapButton.addEventListener('click', function () {
        if (!video) return; // Garante que o vídeo existe
        
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        fotoPreview.src = canvas.toDataURL('image/jpeg');
        fotoPreview.style.display = 'block';
        cameraModal.hide();

        canvas.toBlob(function(blob) {
            fetch("{% url 'api_gerar_url_upload' %}")
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Erro ao obter permissão de upload: ' + data.error);
                        return;
                    }
                    fetch(data.presigned_url, {
                        method: 'PUT',
                        headers: {'Content-Type': 'image/jpeg'},
                        body: blob
                    })
                    .then(response => {
                        if (response.ok) {
                            alert('Foto enviada com sucesso!');
                            fotoUrlInput.value = data.final_url;
                            fotoPreview.src = data.final_url;
                        } else {
                            alert('Falha no upload para a AWS. Verifique o console.');
                        }
                    })
                    .catch(err => {
                        console.error('Erro no upload direto:', err);
                        alert('Erro de rede ao enviar a foto.');
                    });
                });
        }, 'image/jpeg');
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Pega os elementos dos campos pelo atributo 'name' - Mascara para CPF, CEP e Telefone
    const cpfInput = document.querySelector('input[name="cpf"]');
    const CepInput = document.querySelector('input[name="cep"]');
    const telefoneInput = document.querySelector('input[name="telefone"]');

    // Opções da máscara para o telefone (aceita 8 ou 9 dígitos)
    const telefoneMaskOptions = {
        mask: [
            { mask: '(00) 0000-0000' },
            { mask: '(00) 00000-0000' }
        ]
    };

    // Aplica as máscaras
    if(cpfInput)      IMask(cpfInput,      { mask: '000.000.000-00' });
    if(CepInput)      IMask(CepInput,      { mask: '00000-000' });
    if(telefoneInput) IMask(telefoneInput, { mask: '(00) 00000-0000' });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const cpfInput = document.querySelector('input[name="cpf"]');
    const emailInput = document.querySelector('input[name="email"]');
    
    // Pega o ID do cliente da URL, se estiver na página de edição
    const urlParts = window.location.pathname.split('/');
    const clienteId = urlParts.includes('editar') ? urlParts[urlParts.length - 2] : '';

    // Função genérica para verificar um campo
    const checkField = (inputElement, fieldName, feedbackElementId) => {
        const feedbackDiv = document.getElementById(feedbackElementId);
        
        inputElement.addEventListener('blur', function() { // 'blur' é quando o usuário sai do campo
            const value = inputElement.value;
            if (value.length === 0) {
                feedbackDiv.textContent = '';
                return;
            }

            // Monta a URL da nossa API
            const url = `{% url 'api_verificar_duplicidade' %}?field=${fieldName}&value=${value}&cliente_id=${clienteId}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.is_taken) {
                        feedbackDiv.textContent = `Este ${fieldName} já está cadastrado.`;
                        inputElement.classList.add('is-invalid');
                    } else {
                        feedbackDiv.textContent = '';
                        inputElement.classList.remove('is-invalid');
                    }
                });
        });
    };

    // Aplica a função para os campos de CPF e Email
    if (cpfInput) checkField(cpfInput, 'cpf', 'cpf-feedback');
    if (emailInput) checkField(emailInput, 'email', 'email-feedback');
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const nascimentoInput = document.getElementById('{{ form.data_nascimento.id_for_label }}');
    const nascimentoValue = '{{ nascimento_para_js|default:"" }}';

    if (nascimentoInput && nascimentoValue) {
        nascimentoInput.value = nascimentoValue;
    }
});
</script>
{% endblock %}



