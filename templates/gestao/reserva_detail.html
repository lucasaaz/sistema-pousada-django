<!-- ========================================================================== -->
<!-- ARQUIVO: templates/gestao/reserva_detail.html (ATUALIZADO)                 -->
<!-- DESCRIÇÃO: Melhora a lógica dos botões de ação e feedback ao utilizador. -->
<!-- ========================================================================== -->
{% extends 'base.html' %}
{% block title %}Detalhes da Reserva{% endblock %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Detalhes da Reserva {{ reserva.pk }}</h1>
    <div class="btn-group me-2">
        <a href="{% url 'reserva_list' %}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar para Lista
        </a>

        <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-gear-fill"></i> Ações
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
            <li>
                <a class="dropdown-item" href="{% url 'imprimir_contrato_checkin' reserva.pk %}" target="_blank">
                    <i class="bi bi-printer me-2"></i>Imprimir Ficha
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="{% url 'imprimir_contrato_checkin' reserva.pk %}">
                    <i class="bi bi-envelope me-2"></i>Enviar por E-mail
                </a>
            </li>
        </ul>
    </div>
</div>


<script>
    // Este script pode ser removido se o botão for a única forma de impressão.
    // Ele existe como um exemplo de como fazer a ação via JavaScript.
    function imprimirContrato() {
        const url = "{% url 'imprimir_contrato_checkin' reserva.pk %}";
        window.open(url, '_blank');
    }
</script>

<!-- ATENÇÃO: As mensagens de erro/sucesso do check-out aparecerão aqui, pois estão no base.html -->

<div class="row">
    <div class="col-md-8">
        <!-- Card de Informações da Reserva -->
        <div class="card mb-4">
            <div class="card-header">Informações da Reserva</div>
            <div class="card-body">
                <p><strong>Cliente:</strong> {{ reserva.cliente.nome_completo }}</p>
                <p><strong>Acomodação:</strong> {{ reserva.acomodacao.nome_display }}</p>
                <p><strong>Check-in:</strong> {{ reserva.data_checkin|date:"d/m/Y" }}</p>
                <p><strong>Check-out:</strong> {{ reserva.data_checkout|date:"d/m/Y" }}</p>
                <p><strong>Hóspedes:</strong> 
                    {{ reserva.num_adultos }} adulto(s)
                    {% if reserva.num_criancas_5 > 0 %}
                        , {{ reserva.num_criancas_5 }} criança(s) até 5 anos
                    {% endif %}
                    {% if reserva.num_criancas_12 > 0 %}
                        , {{ reserva.num_criancas_12 }} criança(s) de 6 a 12 anos
                    {% endif %}
                </p>
                <p><strong>Status:</strong> 
                    <span class="badge" style="background-color: {{ reserva.status_color }};">
                        {{ reserva.get_status_display }}
                    </span>
                </p>
            </div>
        </div>
        <!-- Card de Consumo -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">Consumo
                {% if reserva.status == 'checkin' %}<a href="{% url 'consumo_add' reserva.pk %}" class="btn btn-sm btn-success"><i class="bi bi-plus-lg"></i> Adicionar Consumo</a>{% endif %}
            </div>
            <div class="card-body p-0">
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Qtd.</th>
                            <th>Preço Unit.</th>
                            <th>Total</th>
                            <th class="text-end">Ações</th> </tr>
                    </thead>
                    <tbody>
                        {% for consumo in reserva.consumos.all %}
                        <tr>
                            <td>{{ consumo.item.nome }}</td>
                            <td>{{ consumo.quantidade }}</td>
                            <td>R$ {{ consumo.preco_unitario|floatformat:2 }}</td>
                            <td>R$ {{ consumo.total|floatformat:2 }}</td>
                            
                            <td class="text-end">
                                <div class="btn-group">
                                    <a href="{% url 'consumo_edit' consumo.pk %}" class="btn btn-sm btn-outline-secondary" title="Editar Consumo">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    
                                    <a href="{% url 'consumo_delete' consumo.pk %}" class="btn btn-sm btn-outline-danger" title="Excluir Consumo">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">Nenhum consumo registado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Card de Pagamentos -->
        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">Pagamentos
                {% if perms.gestao.add_pagamento %}
                    <a href="{% url 'pagamento_add' reserva.pk %}" class="btn btn-sm btn-success">
                        <i class="bi bi-plus-lg"></i> Adicionar Pagamento
                    </a>
                {% endif %}
            </div>
            <div class="card-body p-0">
                <table class="table mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Data</th>
                            <th>Forma de Pagamento</th>
                            <th>Valor</th>
                            <th class="text-end">Ações</th> </tr>
                    </thead>
                    <tbody>
                        {% for pagamento in reserva.pagamentos.all %}
                        <tr>
                            <td>{{ pagamento.data_pagamento|date:"d/m/Y" }}</td>
                            <td>{{ pagamento.forma_pagamento.nome }}</td>
                            <td>R$ {{ pagamento.valor|floatformat:2 }}</td>
                            <td class="text-end">
                                {% if perms.gestao.change_pagamento %}
                                <a href="{% url 'pagamento_edit' pagamento.pk %}" class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="Editar"><i class="bi bi-pencil"></i></a>
                                {% endif %}
                                {% if perms.gestao.delete_pagamento %}
                                <a href="{% url 'pagamento_delete' pagamento.pk %}" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" title="Excluir"><i class="bi bi-trash"></i></a>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-center text-muted py-3">Nenhum pagamento registado.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <!-- ATUALIZAÇÃO: Lógica de Ações corrigida e mais clara -->
        <div class="card mb-4">
            <div class="card-header">Ações</div>
            <div class="card-body text-center">
                {% if reserva.status == 'confirmada' %}
                    <form action="{% url 'fazer_checkin' reserva.pk %}" method="post" class="d-grid">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success">Realizar Check-in</button>
                    </form>
                {% elif reserva.status == 'checkin' %}
                    <form action="{% url 'fazer_checkout' reserva.pk %}" method="post" class="d-grid mb-2">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-warning">Realizar Check-out</button>
                    </form>
                    {% if reserva.saldo_devedor > 0 %}
                        <small class="text-danger">Atenção: A conta precisa ser paga antes do check-out.</small>
                    {% endif %}
                {% else %}
                    <p class="text-muted">Nenhuma ação principal disponível para este status.</p>
                {% endif %}
                <hr>
                <div class="d-grid gap-2">
                    <a href="{% url 'reserva_edit' reserva.pk %}" class="btn btn-secondary btn-sm">Editar Detalhes/Valores</a>
                    {% if reserva.status != 'cancelada' and reserva.status != 'checkout' %}
                        <a href="{% url 'cancelar_reserva_status' reserva.pk %}" class="btn btn-danger btn-sm">Cancelar Reserva</a>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Card de Resumo Financeiro -->
        <div class="card">
            <div class="card-header">Resumo Financeiro</div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between"><span>Diárias:</span> <span>R$ {{ reserva.valor_total_diarias }}</span></li>
                <li class="list-group-item d-flex justify-content-between"><span>(+) Consumo:</span> <span>R$ {{ reserva.valor_consumo }}</span></li>
                <li class="list-group-item d-flex justify-content-between"><span>(+) Extras:</span> <span>R$ {{ reserva.valor_extra }}</span></li>
                <li class="list-group-item d-flex justify-content-between text-danger"><span>(-) Desconto:</span> <span>R$ {{ reserva.desconto }}</span></li>
                <li class="list-group-item d-flex justify-content-between fw-bold"><span>Total a Pagar:</span> <span>R$ {{ reserva.total_a_pagar }}</span></li>
                <li class="list-group-item d-flex justify-content-between text-success"><span>Total Pago:</span> <span>R$ {{ reserva.total_pago }}</span></li>
                <li class="list-group-item d-flex justify-content-between fw-bold {% if reserva.saldo_devedor > 0 %}bg-warning{% else %}bg-light{% endif %}">
                    <span>Saldo Devedor:</span> <span>R$ {{ reserva.saldo_devedor }}</span>
                </li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

