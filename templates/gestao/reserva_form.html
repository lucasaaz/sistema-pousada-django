<!-- ========================================================================== -->
<!-- ARQUIVO: templates/gestao/reserva_form.html (NOVO)                         -->
<!-- ========================================================================== -->
{% extends 'base.html' %}
{% block title %}{% if object %}Editar Reserva{% else %}Adicionar Reserva{% endif %}{% endblock %}

{% block content %}
<main class="px-md-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">{% if object %}Editar Reserva de {{ object.cliente }}{% else %}Adicionar Nova Reserva{% endif %}</h1>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <form method="post" novalidate>
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            <p class="mb-0">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="row g-3">
                    <div class="col-7">
                        <div class="col-md-12 position-relative">
                            <label for="{{ form.cliente_busca.id_for_label }}" class="form-label">{{ form.cliente_busca.label }}</label>
                            {{ form.cliente_busca }} {{ form.cliente }}       <div id="autocomplete-results" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                            {{ form.cliente_busca.errors }}
                            {{ form.cliente.errors }}
                        </div>
                        <div class="row g-3">
                            <div class="col-md-7">
                                <label for="{{ form.acomodacao.id_for_label }}" class="form-label">{{ form.acomodacao.label }}</label>
                                {{ form.acomodacao }}
                                {{ form.acomodacao.errors }}
                            </div>
                            <div class="col-md-5">
                                <label for="{{ form.placa_automovel.id_for_label }}" class="form-label">{{ form.placa_automovel.label }}</label>
                                {{ form.placa_automovel }}
                                {{ form.placa_automovel.errors }}
                            </div>
                        </div>
                    </div>
                    <div class="col-5 d-flex justify-content-start">
                        {% if cliente_foto_url %}
                        <div class="mt-12">
                            <img src="{{ cliente_foto_url }}" alt="Foto do Cliente" class="img-thumbnail" style="max-width: 200px;">
                        </div>
                        {% endif %}
                    </div>

                    <div class="col-12"><hr class="my-2"></div>

                    <div class="col-md-6">
                        <label for="{{ form.data_checkin.id_for_label }}" class="form-label">{{ form.data_checkin.label }}</label>
                        {{ form.data_checkin }}
                        {{ form.data_checkin.errors }}
                    </div>
                    
                    <div class="col-md-6">
                        <label for="{{ form.data_checkout.id_for_label }}" class="form-label">{{ form.data_checkout.label }}</label>
                        {{ form.data_checkout }}
                        {{ form.data_checkout.errors }}
                    </div>

                    <div class="col-12"><hr class="my-2"></div>

                    <div class="col-md-3">
                        <label for="{{ form.num_adultos.id_for_label }}" class="form-label">{{ form.num_adultos.label }}</label>
                        {{ form.num_adultos }}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ form.num_criancas_5.id_for_label }}" class="form-label">{{ form.num_criancas_5.label }}</label>
                        {{ form.num_criancas_5 }}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ form.num_criancas_12.id_for_label }}" class="form-label">{{ form.num_criancas_12.label }}</label>
                        {{ form.num_criancas_12 }}
                    </div>

                    <div class="col-md-3">
                        <div class="row">
                            <div class="col-12">
                                <label for="{{ form.status.id_for_label }}" class="form-label">{{ form.status.label }}</label>
                                {{ form.status }}
                            </div>
                        </div>
                    </div>

                    <div class="col-12"><hr class="my-2"></div>
                    
                    <div class="col-8 mt-2 mx-auto">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <label for="valor-total-input" class="form-label fw-bold">VALOR TOTAL DAS DIÁRIAS (R$)</label>
                                {{ form.valor_total_diarias }}
                                <small class.text-muted id="detalhamento-calculo"></small>
                                <small class="text-muted">(O valor final pode incluir consumos e taxas extras)</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer bg-white text-end px-0 pt-4 mt-3">
                    <a href="{% url 'reserva_list' %}" class="btn btn-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-primary">Salvar Reserva</button>
                </div>
            </form>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
{{ block.super }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Pega todos os elementos que afetam o preço
    const acomodacaoInput = document.getElementById('{{ form.acomodacao.id_for_label }}');
    const checkinInput = document.getElementById('{{ form.data_checkin.id_for_label }}');
    const checkoutInput = document.getElementById('{{ form.data_checkout.id_for_label }}');
    const numAdultosInput = document.getElementById('{{ form.num_adultos.id_for_label }}');
    const numCriancas12Input = document.getElementById('{{ form.num_criancas_12.id_for_label }}');

    const valorDisplay = document.getElementById('valor-total-display');

    function calcularTarifa() {
        const acomodacaoId = acomodacaoInput.value;
        const checkin = checkinInput.value;
        const checkout = checkoutInput.value;
        const numAdultos = parseInt(numAdultosInput.value) || 0;
        const numCriancas12 = parseInt(numCriancas12Input.value) || 0;
        
        if (!acomodacaoId || !checkin || !checkout || (numAdultos + numCriancas12) === 0) {
            valorDisplay.textContent = 'R$ 0,00';
            return;
        }

        const url = `{% url 'api_calcular_tarifa' %}?acomodacao_id=${acomodacaoId}&checkin=${checkin}&checkout=${checkout}&num_adultos=${numAdultos}&num_criancas_12=${numCriancas12}`;
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    // Se a resposta for um erro (400, 500), joga um erro para o .catch()
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const valorInput = document.getElementById('valor-total-input');
                if (data.valor_total !== undefined) {
                    valorInput.value = parseFloat(data.valor_total).toFixed(2);
                    // Bonus: exibe o detalhamento se houver
                    const detalhamentoDisplay = document.getElementById('detalhamento-calculo');
                    if (data.detalhamento && detalhamentoDisplay) {
                        detalhamentoDisplay.textContent = data.detalhamento.join(' | ');
                    }
                } else {
                    valorDisplay.textContent = 'Não aplicável';
                }
            })
            .catch(error => {
                console.error('Erro na chamada da API de tarifa:', error);
                valorDisplay.textContent = 'Erro';
            });
    }

    // Adiciona "escutadores" para todos os campos
    [acomodacaoInput, checkinInput, checkoutInput, numAdultosInput, numCriancas12Input]
        .forEach(el => el.addEventListener('change', calcularTarifa));
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const buscaInput = document.getElementById('{{ form.cliente_busca.id_for_label }}');
    const clienteIdInput = document.getElementById('{{ form.cliente.id_for_label }}');
    const resultsDiv = document.getElementById('autocomplete-results');

    if (buscaInput) {
        buscaInput.addEventListener('keyup', function () {
            const searchTerm = buscaInput.value;
            resultsDiv.innerHTML = ''; // Limpa resultados antigos

            if (searchTerm.length < 2) {
                return; // Só busca com 2+ caracteres
            }

            // Faz a chamada para a nossa API
            fetch(`{% url 'api_buscar_clientes' %}?term=${searchTerm}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(item => {
                        // Cria um item de lista para cada resultado
                        const a = document.createElement('a');
                        a.href = '#';
                        a.classList.add('list-group-item', 'list-group-item-action');
                        a.textContent = item.text;
                        a.dataset.id = item.id;
                        resultsDiv.appendChild(a);

                        // Adiciona o evento de clique para selecionar o cliente
                        a.addEventListener('click', function (e) {
                            e.preventDefault();
                            buscaInput.value = a.textContent; // Preenche o campo de busca
                            clienteIdInput.value = a.dataset.id; // Preenche o campo oculto com o ID
                            resultsDiv.innerHTML = ''; // Limpa a lista
                        });
                    });
                });
        });
        document.addEventListener('click', function(e) {
            if (!buscaInput.contains(e.target)) {
                resultsDiv.innerHTML = '';
            }
        });
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkinInput = document.getElementById('{{ form.data_checkin.id_for_label }}');
    const checkoutInput = document.getElementById('{{ form.data_checkout.id_for_label }}');

    // Pega as strings de data que a view enviou
    const checkinValue = '{{ checkin_para_js|default:"" }}';
    const checkoutValue = '{{ checkout_para_js|default:"" }}';

    // Se o campo e o valor existirem, insere o valor diretamente
    if (checkinInput && checkinValue) {
        checkinInput.value = checkinValue;
    }
    if (checkoutInput && checkoutValue) {
        checkoutInput.value = checkoutValue;
    }
});
</script>
{% endblock %}