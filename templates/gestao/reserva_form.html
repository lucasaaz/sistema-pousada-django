<!-- ========================================================================== -->
<!-- ARQUIVO: templates/gestao/reserva_form.html (NOVO)                         -->
<!-- ========================================================================== -->
{% extends 'base.html' %}
{% block title %}{% if object %}Editar Reserva{% else %}Adicionar Reserva{% endif %}{% endblock %}

{% block content %}
<main class="px-md-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">{% if object %}Editar Reserva de {{ object.cliente }}{% else %}Adicionar Nova Reserva{% endif %}</h1>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <form method="post" novalidate>
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            <p class="mb-0">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="row g-3">
                    <div class="col-7">
                        <div class="col-md-12 position-relative">
                            <label for="{{ form.cliente_busca.id_for_label }}" class="form-label">{{ form.cliente_busca.label }}</label>
                            {{ form.cliente_busca }} {{ form.cliente }}       <div id="autocomplete-results" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                            {{ form.cliente_busca.errors }}
                            {{ form.cliente.errors }}
                        </div>
                        <div class="row g-3">
                            <div class="col-md-7">
                                <label for="{{ form.acomodacao.id_for_label }}" class="form-label">{{ form.acomodacao.label }}</label>
                                {{ form.acomodacao }}
                                {{ form.acomodacao.errors }}
                            </div>
                            <div class="col-md-5">
                                <label for="{{ form.placa_automovel.id_for_label }}" class="form-label">{{ form.placa_automovel.label }}</label>
                                {{ form.placa_automovel }}
                                {{ form.placa_automovel.errors }}
                            </div>
                        </div>
                    </div>
                    <div class="col-5 d-flex justify-content-start">
                        {% if cliente_foto_url %}
                        <div class="mt-12">
                            <img src="{{ cliente_foto_url }}" alt="Foto do Cliente" class="img-thumbnail" style="max-width: 200px;">
                        </div>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        <label for="{{ form.data_checkin.id_for_label }}" class="form-label">{{ form.data_checkin.label }}</label>
                        {{ form.data_checkin }}
                        {{ form.data_checkin.errors }}
                    </div>
                    
                    <div class="col-md-6">
                        <label for="{{ form.data_checkout.id_for_label }}" class="form-label">{{ form.data_checkout.label }}</label>
                        {{ form.data_checkout }}
                        {{ form.data_checkout.errors }}
                    </div>
                    
                    <div class="col-12"><hr class="my-2"></div>

                    <div class="col-md-4">
                        <label for="{{ form.num_adultos.id_for_label }}" class="form-label">{{ form.num_adultos.label }}</label>
                        {{ form.num_adultos }}
                        {{ form.num_adultos.errors }}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.num_criancas_5.id_for_label }}" class="form-label">{{ form.num_criancas_5.label }}</label>
                        {{ form.num_criancas_5 }}
                        {{ form.num_criancas_5.errors }}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.num_criancas_12.id_for_label }}" class="form-label">{{ form.num_criancas_12.label }}</label>
                        {{ form.num_criancas_12 }}
                        {{ form.num_criancas_12.errors }}
                    </div>

                    <div class="col-12"><hr class="my-2"></div>

                    <div class="col-md-4">
                        <label for="{{ form.status.id_for_label }}" class="form-label">{{ form.status.label }}</label>
                        {{ form.status }}
                        {{ form.status.errors }}
                    </div>
                </div>
                
                <div class="card-footer bg-white text-end px-0 pt-4 mt-2">
                    <a href="{% url 'reserva_list' %}" class="btn btn-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-primary">Salvar Reserva</button>
                </div>
            </form>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
{{ block.super }}

<script>
document.addEventListener('DOMContentLoaded', function () {
    const buscaInput = document.getElementById('{{ form.cliente_busca.id_for_label }}');
    const clienteIdInput = document.getElementById('{{ form.cliente.id_for_label }}');
    const resultsDiv = document.getElementById('autocomplete-results');

    if (buscaInput) {
        buscaInput.addEventListener('keyup', function () {
            const searchTerm = buscaInput.value;
            resultsDiv.innerHTML = ''; // Limpa resultados antigos

            if (searchTerm.length < 2) {
                return; // SÃ³ busca com 2+ caracteres
            }

            // Faz a chamada para a nossa API
            fetch(`{% url 'api_buscar_clientes' %}?term=${searchTerm}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(item => {
                        // Cria um item de lista para cada resultado
                        const a = document.createElement('a');
                        a.href = '#';
                        a.classList.add('list-group-item', 'list-group-item-action');
                        a.textContent = item.text;
                        a.dataset.id = item.id;
                        resultsDiv.appendChild(a);

                        // Adiciona o evento de clique para selecionar o cliente
                        a.addEventListener('click', function (e) {
                            e.preventDefault();
                            buscaInput.value = a.textContent; // Preenche o campo de busca
                            clienteIdInput.value = a.dataset.id; // Preenche o campo oculto com o ID
                            resultsDiv.innerHTML = ''; // Limpa a lista
                        });
                    });
                });
        });
        document.addEventListener('click', function(e) {
            if (!buscaInput.contains(e.target)) {
                resultsDiv.innerHTML = '';
            }
        });
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Pega os campos de input de data
    const checkinInput = document.getElementById('{{ form.data_checkin.id_for_label }}');
    const checkoutInput = document.getElementById('{{ form.data_checkout.id_for_label }}');

    // Pega as datas que a view enviou
    const checkinValue = '{{ checkin_para_js|default:"" }}';
    const checkoutValue = '{{ checkout_para_js|default:"" }}';

    // Se o campo e o valor existirem, tenta preencher
    if (checkinInput && checkinValue) {
        checkinInput.value = checkinValue;
    }

    if (checkoutInput && checkoutValue) {
        checkoutInput.value = checkoutValue;
    }
});
</script>
{% endblock %}